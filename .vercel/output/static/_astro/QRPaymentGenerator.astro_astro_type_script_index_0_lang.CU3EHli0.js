function l(d,C,v={}){const m=typeof d=="string"?document.querySelector(d):d;if(!m)return;const L=m.animate(C,{duration:v.duration||300,easing:v.easing||"ease",delay:v.delay||0,fill:"forwards"});return v.complete&&L.addEventListener("finish",v.complete),L}document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{l(".animate-fade-in",[{opacity:0,transform:"translateY(30px)"},{opacity:1,transform:"translateY(0px)"}],{duration:800,easing:"ease-out"})},100),setTimeout(()=>{l(".animate-slide-in-left",[{opacity:0,transform:"translateX(-50px)"},{opacity:1,transform:"translateX(0px)"}],{duration:1e3,easing:"ease-out"})},300),setTimeout(()=>{l(".animate-slide-in-right",[{opacity:0,transform:"translateX(50px)"},{opacity:1,transform:"translateX(0px)"}],{duration:1e3,easing:"ease-out"})},500);const d=document.getElementById("payment-form"),C=document.getElementById("qr-container"),v=document.getElementById("placeholder"),m=document.getElementById("qr-image"),L=document.getElementById("download-btn"),J=document.getElementById("reset-btn"),M=document.getElementById("save-defaults-btn"),S=document.getElementById("save-indicator"),W=document.getElementById("display-iban"),G=document.getElementById("display-amount"),K=document.getElementById("display-communication"),z=document.getElementById("display-communication-container"),Z=document.getElementById("display-beneficiary"),P=document.getElementById("display-beneficiary-container"),b=document.getElementById("amount"),h=document.getElementById("communication"),E=document.getElementById("beneficiary"),x=document.getElementById("qr-color"),y=document.getElementById("bg-color"),I=document.getElementById("transparent-bg"),_=document.getElementById("qr-color-value"),ee=document.getElementById("bg-color-value"),B=document.getElementById("color-preview"),te=document.getElementById("preview-qr-color"),A=document.getElementById("preview-bg-color"),V=document.getElementById("checkbox-bg"),j=document.getElementById("checkbox-check"),F=document.getElementById("qr-style"),k=document.getElementById("qr-size"),R=document.getElementById("export-format"),D=document.getElementById("error-correction"),ne=document.getElementById("template-select"),$=document.getElementById("history-container"),oe=document.getElementById("clear-history-btn"),re=document.getElementById("export-settings-btn"),ae=document.getElementById("import-settings-btn"),Y=document.getElementById("import-file-input");if(!d){console.error("Formulaire non trouv√©");return}se(),ce(),me(),le(),pe(),O();function se(){try{const t=localStorage.getItem("qr-payment-defaults");if(t){const n=JSON.parse(t);console.log("Chargement des valeurs par d√©faut:",n),n.amount&&b&&(b.value=n.amount),n.communication&&h&&(h.value=n.communication),n.beneficiary&&E&&(E.value=n.beneficiary)}}catch(t){console.error("Erreur lors du chargement des valeurs par d√©faut:",t)}}function ce(){try{const t=new URLSearchParams(window.location.search),n=t.get("iban"),e=t.get("amount"),o=t.get("communication"),a=t.get("beneficiary");(n||e||o||a)&&(console.log("Chargement des donn√©es depuis l'URL:",{iban:n,amount:e,communication:o,beneficiary:a}),n&&document.getElementById("iban")&&(document.getElementById("iban").value=n),e&&b&&(b.value=e),o&&h&&(h.value=o),a&&E&&(E.value=a),window.history.replaceState({},document.title,window.location.pathname))}catch(t){console.error("Erreur lors du chargement depuis l'URL:",t)}}function le(){const t={invoice:{amount:"50.00",communication:"Facture #2024-001 - Services professionnels",beneficiary:"Entreprise Services Pro"},donation:{amount:"10.00",communication:"Don pour association caritative",beneficiary:"Association Aide Humanitaire"},rent:{amount:"800.00",communication:"Loyer mensuel - Appartement Rue de la Paix",beneficiary:"Agence Immobili√®re Central"},utilities:{amount:"120.00",communication:"Facture √©lectricit√©/gaz - P√©riode janvier 2024",beneficiary:"Fournisseur √ânergie Plus"},subscription:{amount:"15.00",communication:"Abonnement mensuel - Service Premium",beneficiary:"Plateforme Digitale"},freelance:{amount:"250.00",communication:"Prestation d√©veloppement web - Projet XYZ",beneficiary:"Freelance D√©veloppeur"}};ne?.addEventListener("change",n=>{const e=n.target.value;if(e&&t[e]){const o=t[e];b&&(b.value=o.amount),h&&(h.value=o.communication),E&&(E.value=o.beneficiary),l(d,[{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],{duration:300}),console.log("Template appliqu√©:",e)}}),re?.addEventListener("click",()=>{try{const n={qrColor:x?.value||"#000000",bgColor:y?.value||"#FFFFFF",transparent:I?.checked||!1,style:F?.value||"square",size:k?.value||"300",format:R?.value||"png",errorCorrection:D?.value||"M",exportDate:new Date().toISOString()},e=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),o=URL.createObjectURL(e),a=document.createElement("a");a.href=o,a.download=`qr-generator-config-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),console.log("Configuration export√©e")}catch(n){console.error("Erreur lors de l'export:",n),alert("Erreur lors de l'export de la configuration")}}),ae?.addEventListener("click",()=>{Y?.click()}),Y?.addEventListener("change",n=>{const e=n.target.files?.[0];if(e){const o=new FileReader;o.onload=a=>{try{const r=JSON.parse(a.target?.result);x&&r.qrColor&&(x.value=r.qrColor),y&&r.bgColor&&(y.value=r.bgColor),I&&typeof r.transparent=="boolean"&&(I.checked=r.transparent),F&&r.style&&(F.value=r.style),k&&r.size&&(k.value=r.size),R&&r.format&&(R.value=r.format),D&&r.errorCorrection&&(D.value=r.errorCorrection),U(),console.log("Configuration import√©e"),alert("Configuration import√©e avec succ√®s !")}catch(r){console.error("Erreur lors de l'import:",r),alert("Erreur lors de l'import de la configuration")}},o.readAsText(e)}}),oe?.addEventListener("click",()=>{confirm("√ätes-vous s√ªr de vouloir vider l'historique ?")&&(localStorage.removeItem("qr-payment-history"),O(),console.log("Historique vid√©"))})}function O(){try{const t=JSON.parse(localStorage.getItem("qr-payment-history")||"[]");$&&(t.length===0?$.innerHTML='<p class="text-xs text-gray-500 italic">Aucun QR code g√©n√©r√© r√©cemment</p>':($.innerHTML=t.slice(0,5).map((n,e)=>`
              <div class="flex items-center justify-between p-2 bg-gray-800/30 rounded-lg cursor-pointer hover:bg-gray-700/30 transition-colors" data-history-index="${e}">
                <div class="flex-1 min-w-0">
                  <p class="text-xs text-white font-medium truncate">${n.amount}‚Ç¨ - ${n.communication}</p>
                  <p class="text-xs text-gray-400">${new Date(n.date).toLocaleDateString()}</p>
                </div>
                <button class="text-xs text-emerald-400 hover:text-emerald-300 ml-2 flex-shrink-0">
                  üìã Utiliser
                </button>
              </div>
            `).join(""),$.querySelectorAll("[data-history-index]").forEach((n,e)=>{n.addEventListener("click",()=>{const o=t[e];o&&(b&&(b.value=o.amount),h&&(h.value=o.communication),E&&(E.value=o.beneficiary),l(d,[{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],{duration:300}),console.log("Historique appliqu√©:",o))})})))}catch(t){console.error("Erreur lors du chargement de l'historique:",t)}}function ie(t,n,e,o){try{const a=JSON.parse(localStorage.getItem("qr-payment-history")||"[]"),r={iban:t,amount:n,communication:e,beneficiary:o,date:new Date().toISOString()};a.some(s=>s.iban===t&&s.amount===n&&s.communication===e)||(a.unshift(r),a.length>10&&a.splice(10),localStorage.setItem("qr-payment-history",JSON.stringify(a)),O())}catch(a){console.error("Erreur lors de l'ajout √† l'historique:",a)}}function de(){try{const t={amount:b?.value||"",communication:h?.value||"",beneficiary:E?.value||""};localStorage.setItem("qr-payment-defaults",JSON.stringify(t)),console.log("Valeurs par d√©faut sauvegard√©es:",t),S.classList.remove("hidden"),l(S,[{opacity:0,transform:"translateY(-10px)"},{opacity:1,transform:"translateY(0px)"}],{duration:300}),setTimeout(()=>{l(S,[{opacity:1,transform:"translateY(0px)"},{opacity:0,transform:"translateY(-10px)"}],{duration:300,complete:()=>{S.classList.add("hidden")}})},3e3)}catch(t){console.error("Erreur lors de la sauvegarde:",t),alert("Erreur lors de la sauvegarde des valeurs par d√©faut")}}function ue(){d.reset(),C.classList.add("hidden"),v.classList.remove("hidden"),l(d,[{transform:"scale(1)"},{transform:"scale(0.98)"},{transform:"scale(1)"}],{duration:300}),console.log("Formulaire r√©initialis√©")}function me(){x?.addEventListener("input",t=>{const n=t.target.value;_.textContent=n,te.textContent=n,U(),N()}),y?.addEventListener("input",t=>{const n=t.target.value;ee.textContent=n,A.textContent=n,U(),N()}),I?.addEventListener("change",t=>{t.target.checked?(V.style.opacity="1",j.style.opacity="1",y.disabled=!0,y.style.opacity="0.5"):(V.style.opacity="0",j.style.opacity="0",y.disabled=!1,y.style.opacity="1"),U(),N()})}async function N(){if(!C.classList.contains("hidden")&&m.src){const t=new FormData(d),n=t.get("iban"),e=t.get("amount"),o=t.get("communication"),a=t.get("beneficiary");if(n&&e&&o){const r=n.replace(/\s/g,""),i=`BCD
002
1
SCT

${a||""}
${r}
EUR${e}


${o||""}`,s=await Q(i,300);m.style.opacity="0.7",m.style.transition="opacity 0.3s ease",setTimeout(()=>{m.src=s,m.onload=()=>{m.style.opacity="1",X()}},150),console.log("QR Code mis √† jour avec nouvelles couleurs")}}}function U(){const t=x?.value||"#000000",n=I?.checked?"transparent":y?.value||"#FFFFFF";B&&(B.style.backgroundColor=n==="transparent"?"rgba(0,0,0,0)":n,B.style.color=t,n==="transparent"?(B.style.backgroundImage="linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)",B.style.backgroundSize="8px 8px",B.style.backgroundPosition="0 0, 0 4px, 4px -4px, -4px 0px",A.textContent="Transparent"):(B.style.backgroundImage="none",A.textContent=n)),X()}function X(){if(!C.classList.contains("hidden")&&m.src){const t=x?.value||"#000000",n=I?.checked||!1,e=m.parentElement;if(e)if(n){e.style.backgroundImage="linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #f0f0f0 75%), linear-gradient(-45deg, transparent 75%, #f0f0f0 75%)",e.style.backgroundSize="12px 12px",e.style.backgroundPosition="0 0, 0 6px, 6px -6px, -6px 0px";const o=H(t);o&&o.r>200&&o.g>200&&o.b>200?m.style.filter="drop-shadow(0 0 1px rgba(0,0,0,0.8))":m.style.filter="none"}else e.style.backgroundImage="none",m.style.filter="none"}}function H(t){const n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:null}d.addEventListener("submit",async t=>{t.preventDefault(),console.log("Formulaire soumis");const n=d.querySelector('button[type="submit"]');l(n,[{transform:"scale(1)"},{transform:"scale(0.95)"},{transform:"scale(1)"}],{duration:200});const e=new FormData(d),o=e.get("iban"),a=e.get("amount"),r=e.get("communication"),i=e.get("beneficiary");if(console.log("Donn√©es:",{iban:o,amount:a,communication:r,beneficiary:i}),!o||!a){l(d,[{transform:"translateX(0)"},{transform:"translateX(-10px)"},{transform:"translateX(10px)"},{transform:"translateX(0)"}],{duration:400}),alert("Veuillez remplir tous les champs obligatoires (IBAN et montant)");return}const s=o.replace(/\s/g,""),u=/^BE[0-9]{14}$/,g=/^BE[0-9]{2}\s[0-9]{4}\s[0-9]{4}\s[0-9]{4}$/;if(console.log("=== DEBUG VALIDATION IBAN ==="),console.log("IBAN original:",o),console.log("IBAN nettoy√©:",s),console.log("Longueur IBAN original:",o.length),console.log("Longueur IBAN nettoy√©:",s.length),console.log("Test regex sans espaces:",u.test(s)),console.log("Test regex avec espaces:",g.test(o)),console.log("Regex sans espaces:",u),console.log("Regex avec espaces:",g),!u.test(s)&&!g.test(o)){console.log("‚ùå VALIDATION √âCHOU√âE"),l(d,[{transform:"translateX(0)"},{transform:"translateX(-10px)"},{transform:"translateX(10px)"},{transform:"translateX(0)"}],{duration:400}),alert("Veuillez entrer un IBAN belge valide (format: BE68 5390 0754 7034)");return}console.log("‚úÖ VALIDATION IBAN R√âUSSIE");const p=parseFloat(a);if(isNaN(p)||p<=0||p>999999.99){l(d,[{transform:"translateX(0)"},{transform:"translateX(-10px)"},{transform:"translateX(10px)"},{transform:"translateX(0)"}],{duration:400}),alert("Le montant doit √™tre compris entre 0.01‚Ç¨ et 999,999.99‚Ç¨");return}if(r&&(r.length<3||r.length>140)){l(d,[{transform:"translateX(0)"},{transform:"translateX(-10px)"},{transform:"translateX(10px)"},{transform:"translateX(0)"}],{duration:400}),alert("La communication doit contenir entre 3 et 140 caract√®res si elle est renseign√©e");return}try{const c=`BCD
002
1
SCT

${i||""}
${s}
EUR${a}


${r||""}`;console.log("QR Data:",c);const f=await Q(c,300);l(v,[{opacity:1,transform:"scale(1)"},{opacity:0,transform:"scale(0.8)"}],{duration:300,complete:()=>{v.classList.add("hidden"),C.classList.remove("hidden"),l(C,[{opacity:0,transform:"scale(0.8)"},{opacity:1,transform:"scale(1)"}],{duration:500,easing:"ease-out"})}}),m.src=f,m.onload=()=>{console.log("QR Code charg√© avec couleurs personnalis√©es"),X(),setTimeout(()=>{l(".animate-zoom-in",[{transform:"scale(0)"},{transform:"scale(1.1)"},{transform:"scale(1)"}],{duration:600,easing:"ease-out"})},100),setTimeout(()=>{l(".animate-slide-up",[{opacity:0,transform:"translateY(30px)"},{opacity:1,transform:"translateY(0px)"}],{duration:400,easing:"ease-out"})},400)},W.textContent=o,G.textContent=a,r?(K.textContent=r,z.classList.remove("hidden")):z.classList.add("hidden"),i?(Z.textContent=i,P.classList.remove("hidden")):P.classList.add("hidden"),ie(o,a,r,i)}catch(c){console.error("Erreur lors de la g√©n√©ration du QR code:",c),alert("Erreur lors de la g√©n√©ration du QR code")}}),L.addEventListener("click",async()=>{try{l(L,[{transform:"scale(1)"},{transform:"scale(0.95)"},{transform:"scale(1)"}],{duration:200});const t=new FormData(d),n=t.get("iban"),e=t.get("amount"),o=t.get("communication"),a=t.get("beneficiary");if(n&&e){const r=n.replace(/\s/g,""),i=`BCD
002
1
SCT

${a||""}
${r}
EUR${e}


${o||""}`;console.log("D√©but du t√©l√©chargement...");const s=await Q(i,300);console.log("QR Code g√©n√©r√© pour t√©l√©chargement:",s);const u=I?.checked||!1,g=(x?.value||"#000000").replace("#",""),p=new Date().toISOString().slice(0,19).replace(/:/g,"-"),c=`qr-payment-${e}EUR-${u?"transparent":"colored"}-${p}.png`;if(s.startsWith("data:")){const f=document.createElement("a");f.href=s,f.download=c,document.body.appendChild(f),f.click(),document.body.removeChild(f),console.log("T√©l√©chargement direct (data URL) r√©ussi")}else{const T=await(await fetch(s)).blob(),w=window.URL.createObjectURL(T),q=document.createElement("a");q.href=w,q.download=c,document.body.appendChild(q),q.click(),document.body.removeChild(q),window.URL.revokeObjectURL(w),console.log("T√©l√©chargement via fetch r√©ussi")}console.log("T√©l√©chargement du QR code avec couleurs personnalis√©es termin√©")}}catch(t){console.error("Erreur lors du t√©l√©chargement:",t),alert("Erreur lors du t√©l√©chargement du QR code. Veuillez r√©essayer.")}}),document.getElementById("iban")?.addEventListener("input",t=>{const n=t.target;let e=n.value.replace(/\s/g,"").toUpperCase();console.log("=== DEBUG FORMATAGE IBAN ==="),console.log("Valeur avant formatage:",n.value),console.log("Valeur nettoy√©e:",e),e.length>16&&(e=e.substring(0,16),console.log("Valeur tronqu√©e:",e)),e.length>0&&!e.startsWith("BE")&&(e.startsWith("B")?e="BE"+e.substring(1):e="BE"+e,console.log("Pr√©fixe BE ajout√©:",e));let o="";e.length>=2&&(o=e.substring(0,2),console.log("√âtape 1 - BE:",o),e.length>2&&(o+=e.substring(2,4),console.log("√âtape 2 - BE12:",o),e.length>4&&(o+=" "+e.substring(4,8),console.log("√âtape 3 - BE12 3432:",o),e.length>8&&(o+=" "+e.substring(8,12),console.log("√âtape 4 - BE12 3432 3423:",o),e.length>12&&(o+=" "+e.substring(12,16),console.log("√âtape 5 - BE12 3432 3423 2442:",o)))))),console.log("Valeur finale format√©e:",o),n.value=o,l(n,[{borderColor:"rgb(107, 114, 128)"},{borderColor:"rgb(139, 92, 246)"},{borderColor:"rgb(107, 114, 128)"}],{duration:300})}),document.querySelectorAll("input, textarea").forEach(t=>{t.addEventListener("focus",()=>{t.parentElement&&l(t.parentElement,[{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],{duration:200})})}),J?.addEventListener("click",ue),M?.addEventListener("click",de);async function ge(t,n){return new Promise((e,o)=>{const a=new Image;a.crossOrigin="anonymous",a.onload=()=>{const r=document.createElement("canvas"),i=r.getContext("2d");if(!i){o("Impossible de cr√©er le contexte canvas");return}r.width=a.width,r.height=a.height,i.drawImage(a,0,0);const s=i.getImageData(0,0,r.width,r.height),u=s.data,g=H(n);if(!g){o("Couleur invalide");return}for(let c=0;c<u.length;c+=4){const f=u[c],T=u[c+1],w=u[c+2];f>240&&T>240&&w>240?u[c+3]=0:f<50&&T<50&&w<50&&(u[c]=g.r,u[c+1]=g.g,u[c+2]=g.b,u[c+3]=255)}i.putImageData(s,0,0);const p=r.toDataURL("image/png");e(p)},a.onerror=()=>{o("Erreur lors du chargement de l'image")},a.src=t})}async function Q(t,n=300){const e=(x?.value||"#000000").replace("#",""),o=I?.checked||!1,a=o?"":(y?.value||"#FFFFFF").replace("#",""),r=k?.value||n.toString(),i=D?.value||"M",s=R?.value||"png",u=F?.value||"square",g=encodeURIComponent(t);if(console.log("G√©n√©ration QR Code avec:",{qrColor:e,isTransparent:o,bgColor:a,size:r,errorCorrection:i,format:s,style:u}),o){const p=`https://api.qrserver.com/v1/create-qr-code/?size=${r}x${r}&data=${g}&format=png&margin=10&color=000000&bgcolor=FFFFFF&ecc=${i}`;console.log("URL de base pour transparence:",p);try{const c=await ge(p,"#"+e);return console.log("QR Code transparent cr√©√© avec succ√®s"),c}catch(c){return console.error("Erreur lors de la cr√©ation de la transparence:",c),`https://api.qrserver.com/v1/create-qr-code/?size=${r}x${r}&data=${g}&format=${s}&margin=10&color=${e}&bgcolor=${a||"FFFFFF"}&ecc=${i}`}}else{const p=`https://api.qrserver.com/v1/create-qr-code/?size=${r}x${r}&data=${g}&format=${s}&margin=10&color=${e}&bgcolor=${a}&ecc=${i}`;return console.log("URL QR Code avec fond color√©:",p),p}}function pe(){const t=document.querySelectorAll(".tab-button"),n=document.querySelectorAll(".tab-content");t.forEach(e=>{e.addEventListener("click",()=>{const o=e.id.replace("tab-","content-");t.forEach(r=>{r.classList.remove("active"),r.classList.add("text-gray-400","hover:text-white"),r.classList.remove("bg-gradient-to-r","from-purple-600","to-pink-600","text-white","shadow-lg")}),n.forEach(r=>{r.classList.remove("active"),r.classList.add("hidden")}),e.classList.add("active"),e.classList.remove("text-gray-400","hover:text-white"),e.classList.add("bg-gradient-to-r","from-purple-600","to-pink-600","text-white","shadow-lg");const a=document.getElementById(o);a&&(a.classList.add("active"),a.classList.remove("hidden"),l(a,[{opacity:0,transform:"translateY(10px)"},{opacity:1,transform:"translateY(0px)"}],{duration:300,easing:"ease-out"})),console.log("Onglet activ√©:",o)})})}});
